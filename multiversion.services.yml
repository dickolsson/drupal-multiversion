services:
  # Index Factory
  multiversion.entity_index.factory:
    class: Drupal\multiversion\Entity\Index\MultiversionIndexFactory
    arguments: ['@service_container', '@workspaces.manager']

  # Index children
  multiversion.entity_index.sequence.scope:
    parent: multiversion.entity_index.sequence
    scope: prototype
  multiversion.entity_index.id.scope:
    parent: multiversion.entity_index.id
    scope: prototype
  multiversion.entity_index.uuid.scope:
    parent: multiversion.entity_index.uuid
    scope: prototype
  multiversion.entity_index.rev.scope:
    parent: multiversion.entity_index.rev
    scope: prototype
  multiversion.entity_index.rev.tree.scope:
    parent: multiversion.entity_index.rev.tree
    scope: prototype

  # Indexes
  multiversion.entity_index.sequence:
    class: Drupal\multiversion\Entity\Index\SequenceIndex
    arguments: ['@keyvalue.sorted_set', '@workspaces.manager', '@multiversion.manager']
  multiversion.entity_index.id:
    class: Drupal\multiversion\Entity\Index\EntityIndex
    arguments: ['@keyvalue', '@workspaces.manager']
  multiversion.entity_index.uuid:
    class: Drupal\multiversion\Entity\Index\UuidIndex
    arguments: ['@keyvalue', '@workspaces.manager']
  multiversion.entity_index.rev:
    class: Drupal\multiversion\Entity\Index\RevisionIndex
    arguments: ['@keyvalue', '@workspaces.manager']
  multiversion.entity_index.rev.tree:
    class: Drupal\multiversion\Entity\Index\RevisionTreeIndex
    arguments: ['@keyvalue', '@workspaces.manager', '@multiversion.entity_index.factory']

  multiversion.entity.query.sql:
    decorates: entity.query.sql
    class: Drupal\multiversion\Entity\Query\Sql\QueryFactory
    arguments: ['@database', '@workspaces.manager']
    decoration_priority: 60
    tags:
    - { name: backend_overridable }
  multiversion.manager:
    class: Drupal\multiversion\MultiversionManager
    arguments: ['@workspaces.manager', '@serializer', '@entity.manager', '@state', '@language_manager', '@cache.discovery', '@database', '@entity_field.manager']
    calls:
      - [setContainer, ['@service_container']]
  multiversion.conflict_tracker:
    class: Drupal\multiversion\Conflict\ConflictTracker
    arguments: ['@keyvalue', '@workspaces.manager']
  multiversion.plugin.manager.block:
    decorates: plugin.manager.block
    class: Drupal\multiversion\Block\BlockManager
    decoration_priority: 50
    parent: default_plugin_manager
    arguments: ['@logger.channel.default', '@database', '@workspaces.manager']
  logger.channel.workspace:
    parent: logger.channel_base
    arguments: ['cron']
  conflict.complexlca_resolver:
    class: Drupal\multiversion\Entity\Index\ComplexLcaResolver
    tags:
      - { name: lca_resolver, priority: 20 }
  multiversion.schema_converter_factory:
    class: Drupal\multiversion\Entity\Storage\Sql\MultiversionStorageSchemaConverterFactory
    arguments: ['@entity_type.manager', '@entity.definition_update_manager', '@entity.last_installed_schema.repository', '@keyvalue', '@database', '@entity_field.manager', '@multiversion.manager', '@workspaces.manager']
